<html>
<head>
    <title>Find me a toilet</title>
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="//maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $(".search-query").keyup(function () {
                geocode($(".search-query").val(), function (input, latlng) {
                    $.ajax({
                        type: 'GET',
                        url: "/search",
                        data: {"lat": latlng.lat(), "lng": latlng.lng()},
                        dataType: "json",
                        success: function (results) {
                            clear();
                            $.each(results, function (index) {
                                var toilet = results[index];
                                addToilet(toilet.iconUrl, toilet.name, toilet.address1, toilet.town, toilet.state, toilet.postcode, toilet.addressNote);
                                new google.maps.Marker({
                                    map: map,
                                    position: new google.maps.LatLng(toilet.location.latitude, toilet.location.longitude),
                                    icon: new google.maps.MarkerImage("http://maps.google.com/mapfiles/ms/micons/green-dot.png")
                                });
                            });
                            new google.maps.Marker({
                                map: map,
                                position: latlng,
                                icon: new google.maps.MarkerImage("http://maps.google.com/mapfiles/ms/micons/red-dot.png")
                            });
                            map.panTo(latlng);
                            map.setCenter(latlng);
                            map.setZoom(15);
                        }
                    });
                });
            });
        });
    </script>

    <!-- Map -->
    <script type="text/javascript">
        var map, geocoder;
        function initialize() {
            var mapOptions = {
                zoom: 4,
                center: new google.maps.LatLng(-25, 135),
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById('map'), mapOptions);
            geocoder = new google.maps.Geocoder();
        }

        google.maps.event.addDomListener(window, 'load', initialize);

        function geocode(input, callback) {
            var request = {'address': input, 'region': 'au'};
            geocoder.geocode(request,
                    function (results, status) {
                        if (status == google.maps.GeocoderStatus.OK) {
                            callback(input, results[0].geometry.location);
                        }
                    });
        }
    </script>

    <!-- For simple toilet templating. -->
    <script type="text/javascript">
        String.prototype.format = function () {
            var args = arguments;
            return this.replace(/{(\d+)}/g, function (match, number) {
                return typeof args[number] != 'undefined'
                        ? args[number]
                        : match
                        ;
            });
        };

        function addToilet(url, name, address1, town, state, postcode, notes) {
            var toiletTemplate = $("#toiletTemplate").html();
            var result = toiletTemplate.format(url, name, address1, town, state, postcode, notes);
            $("#results").append(result);
        }

        function clear() {
            $("#results").empty();
        }

    </script>

    <!--
        0: Image URL.
        1: Toilet Name.
        2: Address1.
        3: Town.
        4: State.
        5: Postcode.
        6: Notes.
    -->
    <script type="text/template" id="toiletTemplate">
        <div class="media">
            <img class="media-object pull-left" src="{0}">

            <div class="media-body">
                <h4 class="media-heading">{1}</h4>
                <dl class="dl-horizontal">
                    <dt>Address:</dt>
                    <dd>{2}, {3}, {4} {5}</dd>
                    <dt>Notes:</dt>
                    <dd>{6}</dd>
                </dl>
            </div>
        </div>
    </script>

    <!-- Feel free to express yourself. -->
    <style type="text/css">
        /* This is a fix for an incompatibility between Bootstrap and Google Maps */
        .map img {
            max-width: none;
        }

        body {
            margin-top: 60px;
        }

        .media {
            padding: 8px;
            border: 1px solid #ccc;
        }

        .search-query {
            height: 25px !important;
        }

        .map {
            height: 600px;
            width: 100%;
            border: 1px solid #ccc;
        }
    </style>

</head>
<body>
<div class="container">
    <h1>Public Toilet Search</h1>

    <div class="well">
        <input type="text" class="search-query input-xlarge" placeholder="Enter an address">
    </div>

    <div class="row-fluid">
        <div class="span6">
            <div id="results">
            </div>
        </div>
        <div class="span6">
            <div id="map" class="map">
            </div>
        </div>
    </div>

    <script>
        // For example.
        // addToilet("http://www.toiletmap.gov.au/images/icons/u.gif", "Toilet Name", "123 ABC Street", "Darlo", "NSW", "2010", "Some Notes ...");
    </script>
</div>
</body>
</html>
